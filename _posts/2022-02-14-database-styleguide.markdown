---
layout: post
title:  "数据库规范 V1.0"
date:   2022-02-14 09:40:27 +0800
categories: dev
---

## 指南目的

为了在软件生命周期内规范数据库相关的需求分析、设计、开发、测试、运维工作，特此建立一份基于Mysql的使用规范，本规范不仅是开发也包括使用规范。目前我们推荐使用的数据库版本为Mysql5.7.x。本文档适用于运营开发部的所有项目。

## 查询工具及版本的推荐

### 数据库设计
![workbench](/static/2022-02/mwbfile.png)

数据库设计阶段推荐使用[MySQL Workbench](https://dev.mysql.com/downloads/workbench/)自带的Models工具，直观免费。

### 线上数据库查询
![jsw](/static/2022-02/jsw_demo.png)

线上数据库默认不开直连权限，请通过开发部WEB工具进行数据查询。开通权限请联系你的主管。

## 规范

1. 非特殊情况下，请使用INNODB存储引擎
2. Mysql的存储过程、函数、触发器并不成熟，不建议使用
3. 主外键关系只停留在设计阶段和程序内，不要数据库中做外键约束
4. 做表关联时关联的字段类型一定要是一致的，字符编码集也要一致。utf8和utf8mb不是一个编码集，做关联时索引不会生效请注意。
5. 命名只使用字母、数字、下划线，单词中间使用下划线进行分割。不要出现大写字母
6. 超过100万条记录的表增加字段/索引请先和DBA进行确认，是否需要在下次停机维护时增加。

### 表设计规范

1. 三种类型表名
    1. 业务实体表使用_tb做为表名结尾，紧急迁移时不可丢弃
    2. 非业务实体但与业务需要在同一事物中的使用_tb做为结尾。紧急迁移时可以丢弃的
    3. 日志相关的表，包括重要接口日志。使用_log做为结尾。随时可以清理丢弃
2. 所有表至少包含创建日期字段，对于需要更新的业务表需要额外增加修改日期字段切非空。
3. 所有表必须有主键，尽量使用自增字段，推荐Int类型。
4. 当表字段数过多时(>15)，可分成两张表，一张做为条件查询主表，一张做为详细内容表。
5. 枚举类型表请不要使用int类型，请使用varchar把枚举的具体字符值插入表中
6. 为了便于其他人的理解，所有字段请包含注释。创建正式表时也要包含备注字段
7. 对于程序上就要保持唯一的字段，请加上唯一约束并以_uk结尾
8. 当单表数据大于500万条时考虑要进行归档或分表。归档表名为  原始表名_年月日_bak 命名
9. 表中禁止直接存储文档，请使用对象存储。将URL存入表内
10. 做为where条件查询的列必须是NOT NULL,有空值的列索引会有问题。

### 库设计规范

1. 同一业务数据库也建议分为三类，主库、辅助库、日志库
2. 主库与辅助库会保证在同一实例上，允许在同一事务内。
    1. 主库建议命名为 业务_main_db。主库内只放第一类数据表。主库为同时做本地同步库和异地同步库
    2. 辅助库建议命名为 业务_assist_db。辅助库只放第二类数据表。辅助库只会在本地做同步库
    3. 日志库建议命名为 业务_log_db。日志库不做任何同步操作，理论线上业务也不应读取日志库内数据


### 开发规范

1. 程序内不应有创建、删除、修改表的操作语句。以上都应通过工单形式找DBA进行操作
2. 程序内不要出现select *，要指明具体字段
3. 线上程序不要使用 模糊查询，会非常影响性能
4. 目前springboot项目的数据库连接池推荐为druid-spring-boot-starter的1.1.20版本
5. 禁止在主库上执行统计类操作，请在从库上执行。如果要关联多个实例下的表，请在汇总服务器上执行
6. 当需要进行in查询时，in中包含的值应少于1000个
7. 对于已经有大量数据的业务表，新增SQL时请使用explain进行试探分析


## 数据库同步规划示例

![database](/static/2022-02/db_demo.png)